@using Microsoft.AspNetCore.Mvc.ModelBinding
@{
    ViewData["Title"] = "Запись";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="popup-overlay active" id="confirmPopup">
        <div class="popup">
            <button class="close-btn">&times;</button>
            <h2>Запись создана</h2>
            <p>@TempData["SuccessMessage"]</p>
            <div class="popup-buttons">
                <a asp-area="" asp-controller="Home" asp-action="Index" class="btn btn-primary">
                    <i class="fas fa-check"></i>
                    ОК
                </a>
            </div>
        </div>
    </div>
}

@model AppointmentDataModel
<h3>Запись</h3>
<form method="post">
    <div class="form-section">
        <h2>
            <i class="fas fa-stethoscope"></i>
            Выбор направления
        </h2>
        <div class="panels-container">
            <label class="panel" for="Therapy">
                <input asp-for="Direction" type="radio" name="Direction" id="Therapy" value="Therapy" required />
                <div class="panel-icon">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <h3 class="panel-title">Терапия</h3>
                <div class="checkmark">
                    <i class="fas fa-check"></i>
                </div>
            </label>

            <label class="panel" for="Cardiology">
                <input asp-for="Direction" type="radio" name="Direction" id="Cardiology" value="Cardiology" required />
                <div class="panel-icon">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 class="panel-title">Кардиология</h3>
                <div class="checkmark">
                    <i class="fas fa-check"></i>
                </div>
            </label>

            <label class="panel" for="Ophthalmology">
                <input asp-for="Direction" type="radio" name="Direction" id="Ophthalmology" value="Ophthalmology" required />
                <div class="panel-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <h3 class="panel-title">Офтальмология</h3>
                <div class="checkmark">
                    <i class="fas fa-check"></i>
                </div>
            </label>

            <label class="panel" for="Pediatrics">
                <input asp-for="Direction" type="radio" name="Direction" id="Pediatrics" value="Pediatrics" required />
                <div class="panel-icon">
                    <i class="fas fa-baby"></i>
                </div>
                <h3 class="panel-title">Педиатрия</h3>
                <div class="checkmark">
                    <i class="fas fa-check"></i>
                </div>
            </label>
        <span asp-validation-for="Direction" class="text-danger"></span>
        </div>
    </div>
    <div class="form-section">
        <h2>
            <i class="fas fa-calendar-alt"></i>
            Дата и время приёма
        </h2>
        <div id="timeSelectionContainer">
            @if (ViewData.ModelState["SelectedNumber"]?.ValidationState == ModelValidationState.Invalid)
            {
                <div class="alert alert-danger">Выберите направление!</div>
            }
            <input asp-for="Date" type="date" value="@Model.Date" min="@Model.Date" name="Date" id="dateInput" required /><br />
            <div id="timetableContainer">
                @await Html.PartialAsync("_SchedulePartialView", Model.Timetables)
            </div>

            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p>Обрабатываем запрос...</p>
            </div>
        </div>
    </div>
    <div class="form-section">
        <h2>
            <i class="fas fa-user"></i>
            Личные данные
        </h2>
        <div id="personalDataContainer">
            @if (ViewData.ModelState["SNILS"]?.ValidationState == ModelValidationState.Invalid)
            {
                <div class="alert alert-danger">Неправильно введён СНИЛС!</div>
            }
            @if (ViewData.ModelState["PassportSeries"]?.ValidationState == ModelValidationState.Invalid)
            {
                <div class="alert alert-danger">Неправильно введена серия паспорта!</div>
            }
            @if (ViewData.ModelState["PassportNumber"]?.ValidationState == ModelValidationState.Invalid)
            {
                <div class="alert alert-danger">Неправильно введён номер паспорта!</div>
            }
            @if (ViewData.ModelState["PhoneNumber"]?.ValidationState == ModelValidationState.Invalid)
            {
                <div class="alert alert-danger">Неправильно введён номер телефона!</div>
            }
            <div>
                Фамилия, имя, отчество<br />
                <input asp-for="LastName" type="text" name="LastName" id="lastNameInput" placeholder="Иванов" required/>
                <input asp-for="FirstName" type="text" name="FirstName" id="firstNameInput" placeholder="Иван" required />
                <input asp-for="MiddleName" type=" text" name="MiddleName" id="middleNameInput" placeholder="Иванович (при наличие)" />
            </div>
            Номер СНИЛС<br />
            <input asp-for="SNILS" type="text" name="SNILS" id="snilsInput" placeholder="123-456-789-10" required /><br />
            Данные паспорта<br />
            <input asp-for="PassportSeries" type="text" name="PassportSeries" id="passportSeriesInput" placeholder="1234" required />
            <input asp-for="PassportNumber" type="text" name="PassportNumber" id="passportNumberInput" placeholder="567890" required /><br />
            Номер телефона<br />
            <input asp-for="PhoneNumber" type="text" name="PhoneNumber" id="phoneNumberInput" placeholder="+7(123)4567890" required /><br />
        </div>
    <br />
    <button id="submitButton" class="btn btn-primary">Подтвердить</button>
    </div>
</form>

@section Scripts {
    <script>
        const dateInput = document.getElementById('dateInput');
        const directionInput = document.querySelectorAll('input[name="Direction"]');
        const container = document.getElementById('timetableContainer');
        const personalDataContainer = document.getElementById('personalDataContainer');
        const spinner = document.getElementById('loadingSpinner');
        let selectedDirection;

        const closeButton = document.querySelectorAll('.close-btn');

        dateInput.addEventListener('change', updateView);

        directionInput.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('selected'));
                    radio.closest('.panel').classList.add('selected');
                    selectedDirection = this.value;
                    updateView();
                }
            });
        });

        closeButton.forEach(button => {
                button.addEventListener('click', function() {
                    confirmPopup.classList.remove('active');
                });
            });

        function updateView() {
            // Show loading spinner
            spinner.classList.remove('d-none');
            container.classList.add('d-none')

            let model = {
                Date : dateInput.value,
                Direction : selectedDirection
                        };

            dateInput.scrollIntoView();
            unsubscribeAll();
            // AJAX call to get partial view
            fetch('/Appointment/GetSchedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(model)
            })
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                spinner.classList.add('d-none');
                container.classList.remove('d-none')
                subscribeAll()
            })
            .catch(error => {
                console.error('Error:', error);
                spinner.classList.add('d-none');
                container.classList.remove("d-none")
                container.innerHTML = '<div class="alert alert-danger">Произошла ошибка при получении данных!. Пожалуйста попробуйте снова.</div>';
            });
        }

        function subscribeAll() {
            timetableContainer.querySelectorAll('input[name="SelectedNumber"]').forEach(radio => {
                radio.addEventListener('change', selected);
            });
        }

        function unsubscribeAll() {
            timetableContainer.querySelectorAll('input[name="SelectedNumber"]').forEach(radio => {
                radio.removeEventListener('change', selected);
            });
        }

        function selected() {
            if (this.checked) {
                personalDataContainer.scrollIntoView();
            }
        }
    </script>
}
